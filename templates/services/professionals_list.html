{% extends 'base.html' %}

{% block title %}Profissionais - {{ category.name }} - Conheces Alguém?{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Profissionais - {{ category.name }}</h1>
        <p class="text-gray-600">Encontre profissionais qualificados para o seu serviço</p>
    </div>
    
    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Filtros de Busca</h2>
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Province Filter -->
            <div>
                <label for="province" class="block text-sm font-medium text-gray-700 mb-2">Província</label>
                <select 
                    id="province" 
                    name="province" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onchange="this.form.submit()"
                >
                    <option value="">Todas as províncias</option>
                    {% for province in provinces %}
                    <option value="{{ province.id }}" {% if province_id == province.id %}selected{% endif %}>
                        {{ province.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- City Filter (shown only if province selected) -->
            {% if province_id %}
            <div>
                <label for="city" class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                <select 
                    id="city" 
                    name="city" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onchange="this.form.submit()"
                >
                    <option value="">Todas as cidades</option>
                    {% for city in cities %}
                    <option value="{{ city.id }}" {% if city_id == city.id %}selected{% endif %}>
                        {{ city.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <input type="hidden" name="city" value="">
            {% endif %}
            
            <!-- Rating Filter -->
            <div>
                <label for="min_rating" class="block text-sm font-medium text-gray-700 mb-2">Avaliação Mínima</label>
                <select 
                    id="min_rating" 
                    name="min_rating" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onchange="this.form.submit()"
                >
                    <option value="">Todas</option>
                    <option value="4" {% if min_rating == '4' %}selected{% endif %}>4+ estrelas</option>
                    <option value="3" {% if min_rating == '3' %}selected{% endif %}>3+ estrelas</option>
                    <option value="2" {% if min_rating == '2' %}selected{% endif %}>2+ estrelas</option>
                    <option value="1" {% if min_rating == '1' %}selected{% endif %}>1+ estrela</option>
                </select>
            </div>
            
            <!-- Sort Filter -->
            <div>
                <label for="sort" class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                <select 
                    id="sort" 
                    name="sort" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onchange="this.form.submit()"
                >
                    <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>Melhor Avaliação</option>
                    <option value="bookings" {% if sort_by == 'bookings' %}selected{% endif %}>Mais Reservas</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nome (A-Z)</option>
                </select>
            </div>
        </form>
        
        <!-- Active Filters Display -->
        {% if province_id or city_id or min_rating %}
        <div class="mt-4 pt-4 border-t">
            <p class="text-sm text-gray-600 mb-2">Filtros ativos:</p>
            <div class="flex flex-wrap gap-2">
                {% if province_id %}
                {% for p in provinces %}
                    {% if p.id == province_id %}
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                        Província: {{ p.name }}
                        <a href="?city={{ city_id|default:'' }}&min_rating={{ min_rating|default:'' }}&sort={{ sort_by|default:'rating' }}" class="ml-1 hover:text-red-600">×</a>
                    </span>
                    {% endif %}
                {% endfor %}
                {% endif %}
                {% if city_id %}
                {% for c in cities %}
                    {% if c.id == city_id %}
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                        Cidade: {{ c.name }}
                        <a href="?province={{ province_id|default:'' }}&min_rating={{ min_rating|default:'' }}&sort={{ sort_by|default:'rating' }}" class="ml-1 hover:text-red-600">×</a>
                    </span>
                    {% endif %}
                {% endfor %}
                {% endif %}
                {% if min_rating %}
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                    {{ min_rating }}+ estrelas
                    <a href="?province={{ province_id|default:'' }}&city={{ city_id|default:'' }}&sort={{ sort_by|default:'rating' }}" class="ml-1 hover:text-red-600">×</a>
                </span>
                {% endif %}
                <a href="{% url 'services:professionals_by_category' category.slug %}" 
                   class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium hover:bg-gray-200">
                    Limpar todos
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Results Count -->
    <div class="mb-4">
        <p class="text-gray-600">
            <strong>{{ professionals.count }}</strong> profissional{{ professionals.count|pluralize:"es" }} encontrado{{ professionals.count|pluralize:"s" }}
        </p>
    </div>
    
    <!-- Professionals Grid -->
    {% if professionals %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for professional in professionals %}
        <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow p-6">
            <div class="flex items-start gap-4 mb-4">
                {% if professional.profile_picture %}
                <img src="{{ professional.profile_picture.url }}" alt="{{ professional.name }}" 
                     class="w-20 h-20 rounded-full object-cover">
                {% else %}
                <div class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                    <span class="text-3xl text-gray-400">{{ professional.name|first|upper }}</span>
                </div>
                {% endif %}
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">{{ professional.name }}</h3>
                    {% if professional.average_rating > 0 %}
                    <div class="flex items-center gap-2 mb-2">
                        <div class="flex items-center">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= professional.average_rating|floatformat:0|add:"0" %}
                                    <span class="text-yellow-400 text-sm">★</span>
                                {% else %}
                                    <span class="text-gray-300 text-sm">★</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="text-sm text-gray-600 font-medium">
                            {{ professional.average_rating|floatformat:1 }}
                        </span>
                        <span class="text-xs text-gray-500">
                            ({{ professional.completed_bookings }} reserva{{ professional.completed_bookings|pluralize:"s" }})
                        </span>
                    </div>
                    {% else %}
                    <span class="text-sm text-gray-500">Novo profissional</span>
                    {% endif %}
                </div>
            </div>
            
            {% if professional.bio %}
            <p class="text-gray-600 text-sm mb-4 line-clamp-2">{{ professional.bio|truncatewords:20 }}</p>
            {% endif %}
            
            <div class="flex gap-2">
                <a href="{% url 'accounts:professional_profile' professional.id %}" 
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-center text-gray-700 hover:bg-gray-50 transition-colors text-sm font-medium">
                    Ver Perfil
                </a>
                {% if professional.contact_mode == 'direct' %}
                <a href="https://wa.me/{{ professional.get_whatsapp_number }}" 
                   target="_blank"
                   class="flex-1 bg-green-600 hover:bg-green-700 text-white text-center px-4 py-2 rounded-lg font-semibold transition-colors text-sm flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    Contatar
                </a>
                {% endwith %}
                {% else %}
                <a href="{% url 'bookings:step1_service' category.id %}?professional={{ professional.id }}" 
                   class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center px-4 py-2 rounded-lg font-semibold transition-colors text-sm">
                    Reservar
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
        <svg class="w-16 h-16 text-yellow-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">Nenhum profissional encontrado</h3>
        <p class="text-gray-600 mb-4">
            Não encontramos profissionais que correspondam aos seus filtros.
        </p>
        <a href="{% url 'services:professionals_by_category' category.slug %}" 
           class="inline-block px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
            Limpar Filtros
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
